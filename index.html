<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no" />
  <title>Pong ‚Äì Pay to Play (Unique Music per Level)</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      background: black;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: system-ui, sans-serif;
    }
    canvas {
      border: 2px solid white;
      width: 90vw;
      max-width: 480px;
      aspect-ratio: 4 / 3;
      background: black;
    }
    .overlay {
      position: fixed;
      inset: 0;
      display: grid;
      place-items: center;
      background: rgba(0,0,0,0.85);
      color: white;
      text-align: center;
      padding: 20px;
    }
    button {
      background: #1dd979;
      border: 0;
      padding: 10px 20px;
      border-radius: 10px;
      color: #04130c;
      font-weight: 700;
      cursor: pointer;
      margin-top: 10px;
    }
    #status { margin-top: 8px; font-size: 14px; color: #ccc; }
    #lossCounter {
      color: #1dd979;
      font-size: 18px;
      margin-top: 5px;
      font-weight: bold;
    }
    #mute-btn {
      position: fixed;
      top: 12px;
      right: 12px;
      background: rgba(255,255,255,0.15);
      border: 2px solid #1dd979;
      color: #1dd979;
      padding: 6px 10px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
      z-index: 15;
    }
    #mobile-controls {
      position: fixed;
      bottom: 14px;
      display: none;
      gap: 12px;
      z-index: 10;
    }
    .ctrl-btn {
      width: 72px;
      height: 72px;
      font-size: 26px;
      border-radius: 14px;
      border: none;
      background: #1dd979;
      color: #04130c;
      font-weight: 800;
      box-shadow: 0 6px 14px rgba(0,0,0,0.35);
      touch-action: none;
      user-select: none;
    }
    @media (max-width: 720px) {
      #mobile-controls { display: flex; }
    }
  </style>
</head>
<body>
  <button id="mute-btn">üîä Sound On</button>

  <div id="intro" class="overlay">
    <div>
      <h2>üéÆ Pong Game</h2>
      <p id="intro-msg">To start, a small Base transaction is required.</p>
      <button id="payPlay">Pay & Play</button>
      <div id="status"></div>
    </div>
  </div>

  <div id="lossCounter"></div>
  <canvas id="game"></canvas>

  <div id="mobile-controls">
    <button class="ctrl-btn" id="btn-up">‚Üë</button>
    <button class="ctrl-btn" id="btn-down">‚Üì</button>
  </div>

  <script type="module">
    import { sdk } from 'https://esm.sh/@farcaster/miniapp-sdk';
    sdk.actions.ready();

    const RECIPIENT = "0x426FD750993B9af7bf500762B15a9EdBB9253Bb2";
    const AMOUNT_ETH = "0.00001";
    const BASE = { chainId: "0x2105", explorer: "https://basescan.org/tx/" };

    const introEl = document.getElementById('intro');
    const introMsg = document.getElementById('intro-msg');
    const statusEl = document.getElementById('status');
    const lossEl = document.getElementById('lossCounter');
    const muteBtn = document.getElementById('mute-btn');

    let pong = null;
    let totalLosses = 0;
    let maxLosses = 7;
    let level = 1;
    let resetAfterCycle = false;
    let firstPlay = true;
    let muted = false;

    // ===== üéµ MULTI-LEVEL MUSIC =====
    let audioCtx = null;
    let activeSource = null;
    let loopTimer = null;
    const calmVolume = 0.02;

    const levelMusicData = [
      { notes: [261.6, 329.6, 392.0, 440.0], wave: "sine" },       // lvl1 ‚Äì soft & basic
      { notes: [293.7, 349.2, 440.0, 493.9], wave: "triangle" },  // lvl2 ‚Äì warm
      { notes: [329.6, 392.0, 523.3, 587.3], wave: "square" },    // lvl3 ‚Äì brighter
      { notes: [392.0, 440.0, 587.3, 659.3], wave: "sawtooth" },  // lvl4 ‚Äì sharper
      { notes: [440.0, 523.3, 659.3, 783.9], wave: "sine" },      // lvl5+
    ];

    function playMusicForLevel(lvl) {
      if (muted) return;
      stopMusic();

      if (!audioCtx)
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();

      const { notes, wave } = levelMusicData[Math.min(lvl - 1, levelMusicData.length - 1)];
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();

      osc.type = wave;
      let t = audioCtx.currentTime;
      for (let i = 0; i < 32; i++) {
        const n = notes[i % notes.length];
        osc.frequency.setValueAtTime(n, t);
        gain.gain.setValueAtTime(calmVolume, t);
        t += 0.35; // tempo slower ‚Üí calm
      }

      gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.2);
      osc.connect(gain);
      gain.connect(audioCtx.destination);

      osc.start();
      osc.stop(t);
      activeSource = osc;
      loopTimer = setTimeout(() => playMusicForLevel(lvl), 14000);
    }

    function stopMusic() {
      try { if (activeSource) activeSource.stop(); } catch {}
      activeSource = null;
      if (loopTimer) clearTimeout(loopTimer);
    }

    muteBtn.addEventListener("click", () => {
      muted = !muted;
      muteBtn.textContent = muted ? "üîá Sound Off" : "üîä Sound On";
      if (muted) stopMusic(); else playMusicForLevel(level);
    });

    // ===== GAME LOGIC =====
    const show = msg => statusEl.innerHTML += msg + "<br>";
    const clearStatus = () => statusEl.innerHTML = "";
    const updateLossDisplay = () => lossEl.textContent = `üíÄ Losses: ${totalLosses}/${maxLosses} | Level ${level}`;

    async function getProvider() {
      try { const p = await sdk.wallet.getEthereumProvider(); if (p) return p; } catch {}
      return window.ethereum ?? null;
    }

    async function requiredPayment() {
      clearStatus();
      show("üîç Connecting wallet‚Ä¶");
      const provider = await getProvider();
      if (!provider) throw new Error("No wallet found");
      show("‚úÖ Wallet ready.");
      const [from] = await provider.request({ method: "eth_requestAccounts" });
      show("üëõ " + from.slice(0,6) + "‚Ä¶" + from.slice(-4));
      await provider.request({ method: "wallet_switchEthereumChain", params: [{ chainId: BASE.chainId }] });
      show("üîÑ On Base network‚Ä¶");
      const value = "0x" + (BigInt(parseFloat(AMOUNT_ETH) * 1e18)).toString(16);
      const hash = await provider.request({
        method: "eth_sendTransaction",
        params: [{ from, to: RECIPIENT, value }]
      });
      show(`‚úÖ TX sent. <a target="_blank" href="${BASE.explorer}${hash}">View</a>`);
      return hash;
    }

    document.getElementById("payPlay").addEventListener("click", async () => {
      try {
        const btn = document.getElementById("payPlay");
        btn.disabled = true;
        await requiredPayment();
        introEl.style.display = "none";
        totalLosses = 0;

        if (firstPlay) {
          firstPlay = false;
        } else {
          if (resetAfterCycle) {
            maxLosses = 7;
            level = 1;
            resetAfterCycle = false;
          } else if (maxLosses > 1) {
            maxLosses--;
            level++;
            if (maxLosses === 1) resetAfterCycle = true;
          }
        }

        updateLossDisplay();
        if (!pong) pong = startPong();
        else pong.resume();

        playMusicForLevel(level);
      } catch {
        show("‚ùå Payment required to play.");
      } finally {
        document.getElementById("payPlay").disabled = false;
      }
    });

    // ===== Pong =====
    function startPong() {
      const canvas = document.getElementById("game");
      const ctx = canvas.getContext("2d");
      const rect = canvas.getBoundingClientRect();
      canvas.width = rect.width;
      canvas.height = rect.height;

      const grid = Math.max(10, canvas.width / 50);
      const paddleH = grid * 5;
      const maxY = canvas.height - grid - paddleH;
      let paddleSpeed = 6, ballSpeed = 4;
      let paused = false, rafId = null;

      const bot = { x: grid*2, y: canvas.height/2 - paddleH/2, w: grid, h: paddleH };
      const player = { x: canvas.width - grid*3, y: canvas.height/2 - paddleH/2, w: grid, h: paddleH, dy: 0 };
      const ball = { x: canvas.width/2, y: canvas.height/2, w: grid, h: grid, dx: ballSpeed, dy: -ballSpeed };

      function resetBall() {
        ball.x = canvas.width/2;
        ball.y = canvas.height/2;
        ball.dx = ballSpeed * (Math.random() > 0.5 ? 1 : -1);
        ball.dy = ballSpeed * (Math.random() > 0.5 ? 1 : -1);
      }

      function pauseGame() {
        paused = true;
        if (rafId) cancelAnimationFrame(rafId);
        ball.dx = 0; ball.dy = 0;
        stopMusic();
        introMsg.textContent = `You reached ${maxLosses} losses! Please pay to continue.`;
        clearStatus();
        introEl.style.display = "grid";
      }

      function loseRound() {
        totalLosses++;
        updateLossDisplay();
        if (totalLosses >= maxLosses) {
          pauseGame();
          return true;
        }
        resetBall();
        return false;
      }

      function loop() {
        if (paused) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        player.y += player.dy;
        if (player.y < grid) player.y = grid;
        else if (player.y > maxY) player.y = maxY;

        const botCenter = bot.y + bot.h / 2;
        if (botCenter < ball.y - 10) bot.y += paddleSpeed * 0.6;
        else if (botCenter > ball.y + 10) bot.y -= paddleSpeed * 0.6;

        ball.x += ball.dx;
        ball.y += ball.dy;

        if (ball.y < grid || ball.y + grid > canvas.height - grid) ball.dy *= -1;

        if (ball.x > canvas.width) {
          if (loseRound()) return;
        } else if (ball.x < 0) {
          resetBall();
        }

        if (ball.x < bot.x + bot.w && ball.x + ball.w > bot.x && ball.y < bot.y + bot.h && ball.y + ball.h > bot.y)
          ball.dx *= -1;
        if (ball.x < player.x + player.w && ball.x + ball.w > player.x && ball.y < player.y + player.h && ball.y + ball.h > player.y)
          ball.dx *= -1;

        ctx.fillStyle = "white";
        ctx.fillRect(bot.x, bot.y, bot.w, bot.h);
        ctx.fillRect(player.x, player.y, player.w, player.h);
        ctx.fillRect(ball.x, ball.y, ball.w, ball.h);

        rafId = requestAnimationFrame(loop);
      }

      document.addEventListener("keydown", e => {
        if (e.which === 38) player.dy = -paddleSpeed;
        else if (e.which === 40) player.dy = paddleSpeed;
      });
      document.addEventListener("keyup", e => {
        if ([38, 40].includes(e.which)) player.dy = 0;
      });

      const upBtn = document.getElementById('btn-up');
      const downBtn = document.getElementById('btn-down');
      const startUp = (ev) => { ev.preventDefault(); player.dy = -paddleSpeed; };
      const startDown = (ev) => { ev.preventDefault(); player.dy = paddleSpeed; };
      const stopMove = (ev) => { ev.preventDefault(); player.dy = 0; };

      [['touchstart','mousedown'], ['touchend','mouseup','mouseleave']].forEach((arr, i) => {
        const isStart = i === 0;
        arr.forEach(evt => {
          upBtn.addEventListener(evt, isStart ? startUp : stopMove, { passive: false });
          downBtn.addEventListener(evt, isStart ? startDown : stopMove, { passive: false });
        });
      });

      resetBall();
      updateLossDisplay();
      rafId = requestAnimationFrame(loop);

      return {
        resume() {
          paused = false;
          totalLosses = 0;
          updateLossDisplay();
          resetBall();
          playMusicForLevel(level);
          rafId = requestAnimationFrame(loop);
        }
      };
    }
  </script>
</body>
</html>

